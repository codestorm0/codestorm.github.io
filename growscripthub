<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GrowScript Hub — Store</title>
  <style>
    /* Reset & layout */
    :root{--accent:#7afcff;--accent2:#ffd166;--card-bg:rgba(10,10,12,0.6);--glass:rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#fff;background:#07060a;}
    #canvas-bg{position:fixed;inset:0;z-index:-2}
    .overlay{position:fixed;inset:0;backdrop-filter:blur(6px);z-index:-1}

    header{display:flex;align-items:center;justify-content:space-between;padding:18px 28px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:46px;height:46px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#120f1a}
    h1{margin:0;font-size:20px}

    main{padding:24px;max-width:1200px;margin:0 auto}
    .topbar{display:flex;gap:12px;align-items:center;margin-bottom:14px}
    .search{flex:1}

    /* grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:18px}

    .card{background:var(--card-bg);border-radius:12px;padding:14px;backdrop-filter:blur(6px);box-shadow:0 6px 20px rgba(0,0,0,0.6)}
    .card img{width:100%;height:140px;object-fit:cover;border-radius:8px;margin-bottom:10px}
    .meta{display:flex;justify-content:space-between;align-items:center}
    .title{font-weight:700}
    .desc{font-size:13px;color:#d6d6d6;margin:8px 0}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;padding:8px 12px;border-radius:8px;color:#120f1a;font-weight:700;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.08);color:#fff}

    /* aside admin */
    .admin-panel{position:fixed;right:18px;top:80px;width:340px;max-height:76vh;overflow:auto;padding:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;border:1px solid rgba(255,255,255,0.04)}
    .inpt,textarea,select{width:100%;padding:8px;margin:6px 0;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff}
    label{font-size:13px;color:#cfcfcf}

    footer{padding:18px;text-align:center;color:#c4c4c4}

    /* modals */
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,2,2,0.6);backdrop-filter:blur(3px)}
    .modal .panel{width:420px;background:#0a0a0b;padding:18px;border-radius:12px}

    .hint{font-size:12px;color:#aaa}

    /* small responsive tweaks */
    @media (max-width:900px){.admin-panel{position:static;width:auto;margin:12px;border-radius:10px}}
  </style>
</head>
<body>
  <canvas id="canvas-bg"></canvas>
  <div class="overlay"></div>

  <header>
    <div class="brand">
      <div class="logo">GS</div>
      <div>
        <h1 id="site-title">GrowScript Hub</h1>
        <div class="hint" id="site-sub">Free Growsoft Lua Scripts — login to download</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div id="user-box"></div>
      <button class="btn secondary" id="open-login">Login</button>
      <button class="btn" id="open-admin">Admin</button>
    </div>
  </header>

  <main>
    <div class="topbar">
      <div style="display:flex;gap:10px;align-items:center">
        <button class="btn" id="add-script">+ Add Script (Admin)</button>
        <button class="btn secondary" id="clear-storage">Reset Data</button>
      </div>
      <div></div>
    </div>

    <section id="scripts" class="grid" aria-live="polite">
      <!-- script cards injected here -->
    </section>

  </main>

  <aside class="admin-panel" id="admin-panel" style="display:none">
    <h3>Admin Dashboard</h3>
    <div id="admin-controls">
      <div class="hint">Admin user: <strong>codestorm0</strong> / <strong>h7med@123</strong></div>
      <hr>
      <h4>Keys</h4>
      <label>Script ID for key</label>
      <input class="inpt" id="key-script-id" placeholder="script-id" />
      <label>Key (format XXXX-XXXX-XXXX)</label>
      <input class="inpt" id="key-value" placeholder="e.g. ABCD-EFGH-IJKL" />
      <button class="btn" id="generate-key">Add Key</button>
      <div id="keys-list" style="margin-top:10px;font-size:13px;color:#ddd"></div>
      <hr>
      <h4>Site Settings</h4>
      <label>Site title</label>
      <input class="inpt" id="setting-title" />
      <label>Site subtitle</label>
      <input class="inpt" id="setting-sub" />
      <button class="btn" id="save-settings">Save Settings</button>
    </div>
  </aside>

  <!-- Add / Edit Script Modal -->
  <div id="modal-add" class="modal" style="display:none">
    <div class="panel">
      <h3 id="modal-title">Add Script</h3>
      <label>Title</label>
      <input id="s-title" class="inpt" />
      <label>Description</label>
      <textarea id="s-desc" class="inpt" rows="3"></textarea>
      <label>Preview image (URL or upload)</label>
      <input id="s-preview" class="inpt" placeholder="image URL or leave empty and upload below" />
      <input id="s-preview-file" type="file" accept="image/*" />
      <label>Script file (.lua)</label>
      <input id="s-file" type="file" accept=".lua" />
      <label>Price? (leave empty = FREE)</label>
      <input id="s-price" class="inpt" placeholder="e.g. 2 WL + 4 DL or leave blank" />
      <label><input type="checkbox" id="s-paid"/> Mark as paid (requires admin-generated key)</label>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="save-script">Save</button>
        <button class="btn secondary" id="cancel-script">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="modal-login" class="modal" style="display:none">
    <div class="panel">
      <h3>Login</h3>
      <label>Username</label>
      <input id="login-user" class="inpt" />
      <label>Password</label>
      <input id="login-pass" type="password" class="inpt" />
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="do-login">Login</button>
        <button class="btn secondary" id="cancel-login">Cancel</button>
      </div>
      <div class="hint" style="margin-top:8px">Admin credentials are the ones you gave.</div>
    </div>
  </div>

  <footer>GrowScript Hub — built as a single-file demo. Admin: codestorm0</footer>

  <script>
    /* ----------------- Simple galaxy background (canvas) ----------------- */
    const canvas = document.getElementById('canvas-bg');
    const ctx = canvas.getContext('2d');
    let W, H, stars = [];
    function resize(){W=canvas.width=innerWidth;H=canvas.height=innerHeight}
    addEventListener('resize',resize);resize();
    function initStars(){stars=[];for(let i=0;i<220;i++){stars.push({x:Math.random()*W,y:Math.random()*H,z:Math.random()*1.2+0.2,s:Math.random()*1.2+0.2})}}
    initStars();
    function draw(){ctx.clearRect(0,0,W,H);for(let s of stars){let k=(s.z*1.2);ctx.beginPath();ctx.fillStyle='rgba(170,200,255,'+ (0.06+0.6*(1/s.z)) +')';ctx.arc(s.x,s.y, s.s*k,0,Math.PI*2);ctx.fill();}}
    function update(){for(let s of stars){s.x += (s.z*0.25); if(s.x>W+50){s.x=-50; s.y=Math.random()*H; s.z=Math.random()*1.2+0.2}}}
    function loop(){update();draw();requestAnimationFrame(loop);}loop();

    /* ----------------- Storage helpers ----------------- */
    const DB_KEY='gs_store_v1';
    const KEYS_KEY='gs_keys_v1';
    function load(){return JSON.parse(localStorage.getItem(DB_KEY) || '[]')}
    function save(arr){localStorage.setItem(DB_KEY,JSON.stringify(arr))}
    function loadKeys(){return JSON.parse(localStorage.getItem(KEYS_KEY)||'{}')}
    function saveKeys(obj){localStorage.setItem(KEYS_KEY,JSON.stringify(obj))}

    /* ----------------- Simple auth ----------------- */
    let currentUser = JSON.parse(sessionStorage.getItem('gs_user')||'null');
    const adminCred = {user:'codestorm0',pass:'h7med@123'};
    function setUser(u){currentUser=u;sessionStorage.setItem('gs_user',JSON.stringify(u));renderUserBox();}
    function logout(){currentUser=null;sessionStorage.removeItem('gs_user');renderUserBox();}
    function renderUserBox(){const box=document.getElementById('user-box');box.innerHTML='';if(!currentUser){box.innerHTML='<span class="hint">Guest</span>'}else{box.innerHTML=`<span class="hint">${currentUser.user}${currentUser.isAdmin? ' (Admin)':''}</span> <button class="btn secondary" id="logout-btn">Logout</button>`;document.getElementById('logout-btn').onclick=()=>logout();}}
    renderUserBox();

    /* ----------------- UI wiring ----------------- */
    const scriptsEl = document.getElementById('scripts');
    function uid(){return 's-'+Math.random().toString(36).slice(2,9)}

    function render(){
      const arr=load();scriptsEl.innerHTML='';if(arr.length===0){scriptsEl.innerHTML='<div style="grid-column:1/-1;text-align:center;color:#bdbdbd">No scripts yet — admin add one.</div>'}
      for(const s of arr){
        const card=document.createElement('div');card.className='card';
        const img=document.createElement('img');img.src=s.preview || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400"><rect width="100%" height="100%" fill="%230a0a0b"/><text x="50%" y="50%" fill="%23ddd" font-size="22" dominant-baseline="middle" text-anchor="middle">No Preview</text></svg>';
        const title=document.createElement('div');title.className='title';title.textContent=s.title;
        const desc=document.createElement('div');desc.className='desc';desc.textContent=s.desc || '';
        const meta=document.createElement('div');meta.className='meta';
        const left=document.createElement('div');left.appendChild(title);
        const right=document.createElement('div');
        const dlbtn=document.createElement('button');dlbtn.className='btn';dlbtn.textContent='Download';
        dlbtn.onclick=()=>handleDownload(s);
        const editbtn=document.createElement('button');editbtn.className='btn secondary';editbtn.textContent='Edit';editbtn.onclick=()=>openEdit(s.id);
        const delbtn=document.createElement('button');delbtn.className='btn secondary';delbtn.textContent='Delete';delbtn.onclick=()=>deleteScript(s.id);
        right.appendChild(dlbtn);
        if(currentUser && currentUser.isAdmin){right.appendChild(editbtn);right.appendChild(delbtn)}
        meta.appendChild(left);meta.appendChild(right);
        card.appendChild(img);card.appendChild(meta);card.appendChild(desc);
        // price / free
        const price = document.createElement('div');price.className='hint';price.style.marginTop='8px';price.textContent = s.price? ('Price: '+s.price) : 'FREE';
        card.appendChild(price);
        scriptsEl.appendChild(card);
      }
    }

    function deleteScript(id){if(!currentUser || !currentUser.isAdmin){alert('only admin') ;return}if(!confirm('Delete script?'))return;let arr=load();arr=arr.filter(x=>x.id!==id);save(arr);render();}

    /* ----------------- Add/Edit modal logic ----------------- */
    const modalAdd = document.getElementById('modal-add');
    let editingId = null;
    document.getElementById('add-script').onclick = ()=>{
      if(!currentUser || !currentUser.isAdmin){alert('Admin only: login as codestorm0');return}
      editingId=null;openModalForAdd();
    }
    function openModalForAdd(){modalAdd.style.display='flex';document.getElementById('modal-title').textContent='Add Script';document.getElementById('s-title').value='';document.getElementById('s-desc').value='';document.getElementById('s-preview').value='';document.getElementById('s-file').value='';document.getElementById('s-price').value='';document.getElementById('s-preview-file').value='';document.getElementById('s-paid').checked=false}
    function openEdit(id){const arr=load();const s=arr.find(x=>x.id===id);if(!s){alert('not found');return}editingId=id;modalAdd.style.display='flex';document.getElementById('modal-title').textContent='Edit Script';document.getElementById('s-title').value=s.title;document.getElementById('s-desc').value=s.desc;document.getElementById('s-preview').value=s.preview||'';document.getElementById('s-price').value=s.price||'';document.getElementById('s-paid').checked=!!s.paid}
    document.getElementById('cancel-script').onclick=()=>modalAdd.style.display='none';

    async function getFileData(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file)})}

    document.getElementById('save-script').onclick = async ()=>{
      if(!currentUser || !currentUser.isAdmin){alert('admin only');return}
      const title=document.getElementById('s-title').value.trim();
      if(!title){alert('Title needed');return}
      const desc=document.getElementById('s-desc').value.trim();
      const previewInput=document.getElementById('s-preview').value.trim();
      const previewFile=document.getElementById('s-preview-file').files[0];
      const scriptFile=document.getElementById('s-file').files[0];
      const price=document.getElementById('s-price').value.trim();
      const paid=document.getElementById('s-paid').checked;
      let preview = previewInput || '';
      if(previewFile){preview = await getFileData(previewFile)}
      // store script file as blob URL and preserve original filename in metadata
      let fileMeta = null;
      if(scriptFile){const blob = new Blob([await scriptFile.arrayBuffer()],{type:scriptFile.type||'text/plain'});const url = URL.createObjectURL(blob);fileMeta={url,origName:scriptFile.name,blob}
      }
      let arr=load();
      if(editingId){ // update
        const idx=arr.findIndex(x=>x.id===editingId);
        if(idx===-1){alert('not found');return}
        arr[idx].title=title;arr[idx].desc=desc;arr[idx].preview=preview;arr[idx].price=price;arr[idx].paid=paid; if(fileMeta){arr[idx].file=fileMeta}
      } else {
        const newS = {id:uid(),title,desc,preview,price,paid,file:fileMeta,created:Date.now()};arr.unshift(newS);
      }
      save(arr);render();modalAdd.style.display='none';
    }

    /* ----------------- Download & key logic ----------------- */
    function handleDownload(s){
      if(!s.file || !s.file.url){alert('No script file uploaded.');return}
      if(s.paid){ // require key
        const key = prompt('This script requires a download key. Enter key:');
        if(!key) return; const keys=loadKeys(); const list = keys[s.id]||[]; const found = list.find(k=>k.value===key && !k.used);
        if(found){ // mark used and allow download
          found.used=true; found.usedBy = currentUser? currentUser.user : 'guest'; found.usedAt = Date.now(); saveKeys(keys); triggerDownload(s.file.url, s.file.origName); alert('Key accepted — download will start'); renderKeysList();render();
        } else {alert('Invalid or used key');}
      } else {
        if(!currentUser){alert('You must login to download free scripts.'); return}
        triggerDownload(s.file.url,s.file.origName);
      }
    }
    function triggerDownload(url, filename){const a=document.createElement('a');a.href=url;a.download=filename||'script.lua';document.body.appendChild(a);a.click();a.remove();}

    /* ----------------- Keys manager ----------------- */
    document.getElementById('generate-key').onclick = ()=>{
      if(!currentUser || !currentUser.isAdmin){alert('admin only');return}
      const sid=document.getElementById('key-script-id').value.trim(); if(!sid){alert('script id needed');return}
      const val=document.getElementById('key-value').value.trim() || generateKey();
      const store = loadKeys(); if(!store[sid]) store[sid]=[]; store[sid].push({value:val,used:false}); saveKeys(store);renderKeysList();document.getElementById('key-value').value='';document.getElementById('key-script-id').value='';}

    function generateKey(){return Math.random().toString(36).toUpperCase().slice(2,6)+'-'+Math.random().toString(36).toUpperCase().slice(2,6)+'-'+Math.random().toString(36).toUpperCase().slice(2,6)}
    function renderKeysList(){const el=document.getElementById('keys-list');const store=loadKeys();let html='';for(const sid in store){html+='<div style="margin-bottom:6px"><strong>'+sid+'</strong><br/>' + store[sid].map(k=>'<span style="display:inline-block;padding:6px;border-radius:6px;background:rgba(255,255,255,0.03);margin:4px">'+k.value+(k.used? ' (USED)':'')+'</span>').join('') + '</div>'}
      el.innerHTML = html || '<div class="hint">No keys yet.</div>';
    }

    /* ----------------- login modal wiring ----------------- */
    document.getElementById('open-login').onclick=()=>{document.getElementById('modal-login').style.display='flex'}
    document.getElementById('cancel-login').onclick=()=>document.getElementById('modal-login').style.display='none'
    document.getElementById('do-login').onclick=()=>{
      const u=document.getElementById('login-user').value.trim();const p=document.getElementById('login-pass').value;
      if(!u){alert('user required');return}
      if(u===adminCred.user && p===adminCred.pass){setUser({user:u,isAdmin:true});document.getElementById('modal-login').style.display='none';render();renderKeysList();document.getElementById('admin-panel').style.display='block';return}
      // normal login (no password checks for demo)
      setUser({user:u,isAdmin:false});document.getElementById('modal-login').style.display='none';
      render();
    }

    /* ----------------- admin panel toggle & settings ----------------- */
    document.getElementById('open-admin').onclick=()=>{
      if(!currentUser || !currentUser.isAdmin){alert('Admin only');return}
      const p=document.getElementById('admin-panel'); p.style.display = (p.style.display==='none')? 'block':'block'; renderKeysList();
      document.getElementById('setting-title').value = document.getElementById('site-title').textContent;
      document.getElementById('setting-sub').value = document.getElementById('site-sub').textContent;
    }
    document.getElementById('save-settings').onclick=()=>{
      document.getElementById('site-title').textContent = document.getElementById('setting-title').value || 'GrowScript Hub';
      document.getElementById('site-sub').textContent = document.getElementById('setting-sub').value || '';
      alert('saved');
    }

    /* ----------------- reset / helper ----------------- */
    document.getElementById('clear-storage').onclick=()=>{if(confirm('Reset local demo data?')){localStorage.removeItem(DB_KEY);localStorage.removeItem(KEYS_KEY);render();renderKeysList();alert('reset')}}

    /* ----------------- boot ----------------- */
    render();renderKeysList();

  </script>
</body>
</html>
